
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---

    function isAuthenticated() {
      return request.auth != null;
    }

    // Fetch the current user's profile
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user is an Admin
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'ADMIN';
    }

    // Multi-tenancy check:
    // Returns true if the authenticated user is the owner (resourceUid matches auth.uid)
    // OR if the authenticated user is staff of the owner (user.employerId matches resourceUid)
    function isOwnerOrStaff(resourceUid) {
      return isAuthenticated() && (
        request.auth.uid == resourceUid || 
        (getUserData().employerId == resourceUid)
      );
    }

    // Prevent users from changing sensitive fields during updates
    // Allow status updates for package payment verification
    function notUpdatingSensitiveFields() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      // Allow status updates if updating to package payment verification status
      return (affectedKeys.hasOnly(['status', 'packageId', 'subscriptionPlan', 'updatedAt']) && 
              request.resource.data.status == 'Pending Payment Verification') ||
             !affectedKeys.hasAny(['role', 'employerId', 'creditLimit', 'walletBalance', 'uid']);
    }

    // Ensure the 'uid' field (ownership) is not changed during update
    function ownershipNotChanged() {
      return request.resource.data.uid == resource.data.uid;
    }
    
    // --- COLLECTION RULES ---

    // 1. Users Collection
    match /users/{userId} {
      // Read: 
      // - Own profile
      // - Profiles of Vendors/Pharmacies (Publicly visible to authenticated users for Marketplace)
      // - Employer/Staff relationship visibility
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        resource.data.role in ['VENDOR', 'PHARMACY'] ||
        resource.data.employerId == request.auth.uid || 
        getUserData().employerId == resource.data.uid ||
        getUserData().employerId == resource.data.employerId
      );
      
      // Create: Sign up (Allow creating own doc)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Update:
      // - Self (Update profile details, BUT NOT sensitive fields like role/credit)
      // - Admin (Full access)
      // - Owner managing Staff (Update staff profiles linked to them)
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && notUpdatingSensitiveFields()) || 
        isAdmin() ||
        (resource.data.employerId == request.auth.uid)
      );

      // Delete: Admin or Owner deleting staff
      allow delete: if isAuthenticated() && (isAdmin() || resource.data.employerId == request.auth.uid);
    }

    // 2. Pending Staff (Invitations)
    match /pending_staff/{docId} {
      allow read, write: if isAuthenticated() && (
        resource == null || 
        resource.data.employerId == request.auth.uid
      );
    }

    // 3. Products (Inventory)
    match /products/{productId} {
      // Read: All authenticated users (Marketplace)
      allow read: if isAuthenticated();
      
      // Create: Owner or Staff creating for their store
      allow create: if isAuthenticated() && isOwnerOrStaff(request.resource.data.uid);

      // Update/Delete: Owner or Staff, must maintain ownership
      allow update: if isAuthenticated() && isOwnerOrStaff(resource.data.uid) && ownershipNotChanged();
      allow delete: if isAuthenticated() && isOwnerOrStaff(resource.data.uid);
    }

    // 4. Orders
    match /orders/{orderId} {
      // Create: Any authenticated user (Customers or Sellers manually creating)
      allow create: if isAuthenticated();
      
      // Read: 
      // - Seller (Owner/Staff checking 'sellerId')
      // - Buyer (Customer checking 'customerId' or creation context)
      allow read: if isAuthenticated() && (
        isOwnerOrStaff(resource.data.sellerId) || 
        resource.data.customerId == request.auth.uid
      );
      
      // Update: Seller (Status updates)
      allow update: if isAuthenticated() && isOwnerOrStaff(resource.data.sellerId);
    }

    // 5. Wholesale (Ghala) Catalog
    match /wholesale_products/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 6. Transactions (Special handling for customer orders)
    // Customers can create transactions for orders (uid = vendorId)
    // Vendors and their staff can read/update/delete their transactions
    match /transactions/{transactionId} {
      // Read: Owner (vendor) or staff, or customer who created it
      allow read: if isAuthenticated() && (
        isOwnerOrStaff(resource.data.uid) ||
        resource.data.userId == request.auth.uid ||
        (resource.data.vendorId && isOwnerOrStaff(resource.data.vendorId))
      );
      
      // Create: Any authenticated user can create transactions
      // Transaction uid should be vendorId (vendor owns the transaction)
      allow create: if isAuthenticated();
      
      // Update/Delete: Only vendor or staff (owner of the transaction)
      allow update, delete: if isAuthenticated() && (
        isOwnerOrStaff(resource.data.uid) ||
        (resource.data.vendorId && isOwnerOrStaff(resource.data.vendorId))
      );
    }

    // 7. Business Data Collections (Strict 'uid' ownership)
    // Applies to: branches, customers, suppliers, purchase_orders, 
    // inventory_adjustments, deliveries, drivers, 
    // credit_applications, wholesale_orders, item_groups, item_categories, item_units
    // expenses, expense_categories, bills, invoices, stock_alerts, alert_settings
    // warehouse_transfers, delivery_tracking, shop_pages, abandoned_carts
    match /{collection}/{docId} {
      allow read: if isAuthenticated() && 
        collection in ['branches', 'customers', 'suppliers', 'purchase_orders', 
                       'inventory_adjustments', 'deliveries', 
                       'drivers', 'credit_applications', 'wholesale_orders',
                       'item_groups', 'item_categories', 'item_units',
                       'expenses', 'expense_categories', 'bills', 'invoices',
                       'stock_alerts', 'alert_settings', 'warehouse_transfers', 'delivery_tracking',
                       'shop_pages', 'abandoned_carts'] &&
        isOwnerOrStaff(resource.data.uid);

      allow create: if isAuthenticated() && 
        collection in ['branches', 'customers', 'suppliers', 'purchase_orders', 
                       'inventory_adjustments', 'deliveries', 
                       'drivers', 'credit_applications', 'wholesale_orders',
                       'item_groups', 'item_categories', 'item_units',
                       'expenses', 'expense_categories', 'bills', 'invoices',
                       'stock_alerts', 'alert_settings', 'warehouse_transfers', 'delivery_tracking',
                       'shop_pages', 'abandoned_carts'] &&
        isOwnerOrStaff(request.resource.data.uid);

      allow update: if isAuthenticated() && 
        collection in ['branches', 'customers', 'suppliers', 'purchase_orders', 
                       'inventory_adjustments', 'deliveries', 
                       'drivers', 'credit_applications', 'wholesale_orders',
                       'item_groups', 'item_categories', 'item_units',
                       'expenses', 'expense_categories', 'bills', 'invoices',
                       'stock_alerts', 'alert_settings', 'warehouse_transfers', 'delivery_tracking',
                       'shop_pages', 'abandoned_carts'] &&
        isOwnerOrStaff(resource.data.uid) && ownershipNotChanged();

      allow delete: if isAuthenticated() && 
        collection in ['branches', 'customers', 'suppliers', 'purchase_orders', 
                       'inventory_adjustments', 'deliveries', 
                       'drivers', 'credit_applications', 'wholesale_orders',
                       'item_groups', 'item_categories', 'item_units',
                       'expenses', 'expense_categories', 'bills', 'invoices',
                       'stock_alerts', 'alert_settings', 'warehouse_transfers', 'delivery_tracking',
                       'shop_pages', 'abandoned_carts'] &&
        isOwnerOrStaff(resource.data.uid);
    }

    // 8. Public Shop Pages (read-only for published shops)
    match /shop_pages/{shopId} {
      allow read: if resource.data.isPublished == true;
      allow write: if isAuthenticated() && isOwnerOrStaff(resource.data.uid);
    }

    // 7. System Packages
    match /packages/{pkgId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 9. Payment Confirmations (Package subscription payments)
    match /payment_confirmations/{confirmationId} {
      // Read: Own confirmations or Admin can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Any authenticated user can create their own payment confirmations
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Update/Delete: Only admins (for verification/management)
      allow update, delete: if isAdmin();
    }

    // 10. Audit Logs
    match /audit_logs/{logId} {
      // Read: Own logs or Admin can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Any authenticated user can create audit logs
      allow create: if isAuthenticated();
      
      // Update/Delete: Only admins (logs should be immutable)
      allow update, delete: if isAdmin();
    }
  }
}
